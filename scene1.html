<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scene 1: Education Enrollment vs CO2 Emissions</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { font-family: Arial, sans-serif; }
        .tooltip { position: absolute; background-color: white; border: 1px solid #ddd; padding: 10px; display: none; }
        button { margin: 5px; }
        .annotation { font-size: 14px; fill: #333; }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        .animated-text {
            animation: fadeInOut 10s ease-in-out infinite;
        }
        #gdpFilter {
            width: 200px;
            margin: 10px 0;
        }
        #animatedAnnotation {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div>
        <h1>Education and Environmental Impact: A Global Perspective</h1>
    </div>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="scene1.html">Scene 1</a></li>
            <li><a href="scene2.html">Scene 2</a></li>
            <li><a href="scene3.html">Scene 3</a></li>
        </ul>
    </nav>
    <main role="main">
        <h2>Scene 1: Education Enrollment vs CO2 Emissions by Country including GDP</h2>
        <div id="annotation" class="animated-text" style="text-align: center; margin: 10px 0;">
            Hover over the data points to view Country, Education %, CO2 Emissions and GDP
        </div>
        <div>
            <button onclick="updateChart('primary')">Primary Education</button>
            <button onclick="updateChart('tertiary')">Tertiary Education</button>
        </div>
        <div>
            <label for="gdpFilter">Filter by GDP (in billions): $<span id="gdpValue">0</span></label>
            <input type="range" id="gdpFilter" min="0" max="1000" value="0" step="10">
        </div>
        <div id="chart" style="position: relative;">
            <div id="animatedAnnotation"></div>
        </div>
    </main>
    <footer>Explanation for school enrollment over 100%: https://datahelpdesk.worldbank.org/knowledgebase/articles/1986157-how-can-school-enrollment-and-completion-indicator</footer>
    <script src="main.js"></script>
    <script>
        const margin = {top: 50, right: 200, bottom: 50, left: 70};
        const width = 800 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
    
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
    
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip");
    
        const xScale = d3.scaleLinear().range([0, width]);
        const yScale = d3.scaleLog().range([height, 0]);
        const colorScale = d3.scaleSequential(d3.interpolateRainbow);
    
        const xAxis = d3.axisBottom(xScale).ticks(5).tickFormat(d => d + "%");
        const yAxis = d3.axisLeft(yScale)
            .ticks(5)
            .tickFormat(d => d3.format(".1s")(d).replace("G", "B"));
    
        const xAxisGroup = svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .attr("class", "x-axis");
    
        const yAxisGroup = svg.append("g")
            .attr("class", "y-axis");
    
        const xLabel = svg.append("text")
            .attr("text-anchor", "middle")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 10);
    
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("transform", "rotate(-90)")
            .attr("x", -height / 2)
            .attr("y", -margin.left + 20)
            .text("CO2 Emissions (kt)");
    
        const legend = svg.append("g")
            .attr("transform", `translate(${width}, 0)`);
    
        legend.append("text")
            .attr("class", "legend-title")
            .attr("x", 0)
            .attr("y", -10)
            .style("font-weight", "bold");
    
        const legendGradient = legend.append("defs")
            .append("linearGradient")
            .attr("id", "legendGradient")
            .attr("x1", "0%")
            .attr("x2", "0%")
            .attr("y1", "100%")
            .attr("y2", "0%");
    
        legend.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 20)
            .attr("height", 150)
            .style("fill", "url(#legendGradient)");
    
        const legendScale = d3.scaleLinear()
            .range([150, 0]);
    
        const legendAxis = d3.axisRight(legendScale)
            .ticks(5)
            .tickFormat(d3.format(".2s"));
    
        legend.append("g")
            .attr("transform", "translate(20, 0)")
            .attr("class", "legend-axis");
    
        const zoom = d3.zoom()
            .scaleExtent([1, 20])
            .extent([[0, 0], [width, height]])
            .on("zoom", zoomed);
    
        svg.call(zoom);
    
        function zoomed(event) {
            const newX = event.transform.rescaleX(xScale);
            const newY = event.transform.rescaleY(yScale);
            xAxisGroup.call(xAxis.scale(newX));
            yAxisGroup.call(yAxis.scale(newY));
            svg.selectAll("circle")
                .attr("cx", d => newX(d[educationField]))
                .attr("cy", d => newY(d["Co2-Emissions"]));
        }
    
        let data;
        let educationField;
        let gdpThreshold = 0;
    
        const gdpSlider = d3.select("#gdpFilter");
        const gdpValue = d3.select("#gdpValue");

        gdpSlider.on("input", function() {
            gdpThreshold = +this.value * 1e9; // Convert to actual GDP value
            gdpValue.text(this.value);
            updateChart(educationField);
        });
    
        d3.csv("world-data-2023 2.csv").then(function(loadedData) {
            data = loadedData.map(d => ({
                ...d,
                GDP: parseFloat(d.GDP.replace(/[^0-9.-]+/g,"")),
                "Gross primary education enrollment (%)": parseFloat(d["Gross primary education enrollment (%)"]),
                "Gross tertiary education enrollment (%)": parseFloat(d["Gross tertiary education enrollment (%)"]),
                "Co2-Emissions": Math.max(1, parseFloat(d["Co2-Emissions"].replace(/,/g, '')))
            }));
            updateChart('primary');
            animateAnnotation();
        }).catch(function(error) {
            console.log("Error loading the CSV file:", error);
            d3.select("#chart").append("p").text("Error loading data. Please check the console for details.");
        });
    
        function updateChart(educationType) {
            educationField = educationType === 'primary' ? 
                "Gross primary education enrollment (%)" : 
                "Gross tertiary education enrollment (%)";
    
            const filteredData = data.filter(d => 
                !isNaN(d[educationField]) && 
                !isNaN(d["Co2-Emissions"]) && 
                !isNaN(d.GDP) &&
                d.GDP >= gdpThreshold
            );
    
            xScale.domain([0, d3.max(filteredData, d => d[educationField])]).nice();
            yScale.domain([1, d3.max(filteredData, d => d["Co2-Emissions"])]).nice();
            colorScale.domain(d3.extent(filteredData, d => d.GDP));
    
            xAxisGroup.transition().duration(1000).call(xAxis);
            yAxisGroup.transition().duration(1000).call(yAxis);
    
            xLabel.text(`Gross ${educationType} education enrollment (%)`);
    
            legend.select(".legend-title").text("GDP ($)");
            legendGradient.selectAll("stop").remove();
            legendGradient.selectAll("stop")
                .data(colorScale.ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: colorScale(t) })))
                .enter().append("stop")
                .attr("offset", d => d.offset)
                .attr("stop-color", d => d.color);
            legendScale.domain(colorScale.domain());
            legend.select(".legend-axis").call(legendAxis);
    
            const circles = svg.selectAll("circle")
                .data(filteredData, d => d.Country);
    
            circles.enter()
                .append("circle")
                .attr("r", 5)
                .merge(circles)
                .transition()
                .duration(1000)
                .attr("cx", d => xScale(d[educationField]))
                .attr("cy", d => yScale(d["Co2-Emissions"]))
                .attr("fill", d => colorScale(d.GDP))
                .attr("opacity", 0.7);
    
            circles.exit().remove();
    
            svg.selectAll("circle")
                .on("mouseover", function(event, d) {
                    tooltip.style("display", "block")
                        .html(`Country: ${d.Country}<br>
                               Education: ${d[educationField].toFixed(2)}%<br>
                               CO2 Emissions: ${d["Co2-Emissions"].toLocaleString()} kt<br>
                               GDP: $${d.GDP.toLocaleString()}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("display", "none");
                });
        }

        function animateAnnotation() {
            const annotationText = "Move the slider to filter by GDP";
            const annotationDiv = d3.select("#animatedAnnotation");
            
            function animate() {
                annotationDiv.style("opacity", 0)
                    .text(annotationText)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)
                    .transition()
                    .delay(3000)
                    .duration(1000)
                    .style("opacity", 0)
                    .on("end", animate);
            }
            
            animate();
        }
    </script>
</body>
</html>