<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scene 2: CO2 Emissions vs Land Area</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { font-family: Arial, sans-serif; }
        .tooltip { position: absolute; background-color: white; border: 1px solid #ddd; padding: 10px; display: none; }
        button { margin: 5px; }
        .annotation { font-size: 14px; fill: #333; }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        .animated-text {
            animation: fadeInOut 10s ease-in-out infinite;
        }
        #forestFilter {
            width: 200px;
            margin: 10px 0;
        }
        #animatedAnnotation {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div>
        <h1>Education and Environmental Impact: A Global Perspective</h1>
    </div>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="scene1.html">Scene 1</a></li>
            <li><a href="scene2.html">Scene 2</a></li>
            <li><a href="scene3.html">Scene 3</a></li>
        </ul>
    </nav>
    <main role="main">
        <h2>Scene 2: CO2 Emissions vs Land Area</h2>
        <div id="annotation" class="animated-text" style="text-align: center; margin: 10px 0;">
            Hover over the data points to view Country, Land Area, Forested Area, and CO2 Emissions
        </div>
        <div>
            <label for="forestFilter">Filter by Forested Area (%): <span id="forestValue">0</span>%</label>
            <input type="range" id="forestFilter" min="0" max="100" value="0" step="1">
        </div>
        <div id="chart" style="position: relative;">
            <div id="animatedAnnotation"></div>
        </div>
    </main>
    <footer></footer>
    <script src="main.js"></script>
    <script>
        const margin = {top: 50, right: 200, bottom: 50, left: 70};
        const width = 800 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
    
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
    
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip");
    
        const xScale = d3.scaleLog().range([0, width]);
        const yScale = d3.scaleLog().range([height, 0]);
        const colorScale = d3.scaleSequential(d3.interpolateGreens);
    
        const xAxis = d3.axisBottom(xScale).ticks(5).tickFormat(d3.format(".1s"));
        const yAxis = d3.axisLeft(yScale)
            .ticks(5)
            .tickFormat(d3.format(".1s"));
    
        const xAxisGroup = svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .attr("class", "x-axis");
    
        const yAxisGroup = svg.append("g")
            .attr("class", "y-axis");
    
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("x", width / 2)
            .attr("y", height + margin.bottom - 10)
            .text("Land Area (sq km)");
    
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("transform", "rotate(-90)")
            .attr("x", -height / 2)
            .attr("y", -margin.left + 20)
            .text("CO2 Emissions (kt)");
    
        const legend = svg.append("g")
            .attr("transform", `translate(${width}, 0)`);
    
        legend.append("text")
            .attr("class", "legend-title")
            .attr("x", 0)
            .attr("y", -10)
            .style("font-weight", "bold");
    
        const legendGradient = legend.append("defs")
            .append("linearGradient")
            .attr("id", "legendGradient")
            .attr("x1", "0%")
            .attr("x2", "0%")
            .attr("y1", "100%")
            .attr("y2", "0%");
    
        legend.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 20)
            .attr("height", 150)
            .style("fill", "url(#legendGradient)");
    
        const legendScale = d3.scaleLinear()
            .range([150, 0]);
    
        const legendAxis = d3.axisRight(legendScale)
            .ticks(5)
            .tickFormat(d => d + "%");
    
        legend.append("g")
            .attr("transform", "translate(20, 0)")
            .attr("class", "legend-axis");
    
        let data;
        let forestThreshold = 0;
    
        const forestSlider = d3.select("#forestFilter");
        const forestValue = d3.select("#forestValue");

        forestSlider.on("input", function() {
            forestThreshold = +this.value;
            forestValue.text(this.value);
            updateChart();
        });
    
        d3.csv("world-data-2023 2.csv").then(function(loadedData) {
            data = loadedData.map(d => ({
                ...d,
                "Land Area(Km2)": parseFloat(d["Land Area(Km2)"].replace(/,/g, '')),
                "Forested Area (%)": parseFloat(d["Forested Area (%)"]),
                "Co2-Emissions": Math.max(1, parseFloat(d["Co2-Emissions"].replace(/,/g, '')))
            }));
            updateChart();
            animateAnnotation();
        }).catch(function(error) {
            console.log("Error loading the CSV file:", error);
            d3.select("#chart").append("p").text("Error loading data. Please check the console for details.");
        });
    
        function updateChart() {
            const filteredData = data.filter(d => 
                !isNaN(d["Land Area(Km2)"]) && 
                !isNaN(d["Co2-Emissions"]) && 
                !isNaN(d["Forested Area (%)"]) &&
                d["Forested Area (%)"] >= forestThreshold
            );
    
            xScale.domain([d3.min(filteredData, d => d["Land Area(Km2)"]), d3.max(filteredData, d => d["Land Area(Km2)"])]).nice();
            yScale.domain([1, d3.max(filteredData, d => d["Co2-Emissions"])]).nice();
            colorScale.domain([0, 100]);
    
            xAxisGroup.transition().duration(1000).call(xAxis);
            yAxisGroup.transition().duration(1000).call(yAxis);
    
            legend.select(".legend-title").text("Forested Area (%)");
            legendGradient.selectAll("stop").remove();
            legendGradient.selectAll("stop")
                .data(colorScale.ticks().map((t, i, n) => ({ offset: `${100*i/n.length}%`, color: colorScale(t) })))
                .enter().append("stop")
                .attr("offset", d => d.offset)
                .attr("stop-color", d => d.color);
            legendScale.domain(colorScale.domain());
            legend.select(".legend-axis").call(legendAxis);
    
            const circles = svg.selectAll("circle")
                .data(filteredData, d => d.Country);
    
            circles.enter()
                .append("circle")
                .attr("r", 5)
                .merge(circles)
                .transition()
                .duration(1000)
                .attr("cx", d => xScale(d["Land Area(Km2)"]))
                .attr("cy", d => yScale(d["Co2-Emissions"]))
                .attr("fill", d => colorScale(d["Forested Area (%)"]))
                .attr("opacity", 0.7);
    
            circles.exit().remove();
    
            svg.selectAll("circle")
                .on("mouseover", function(event, d) {
                    tooltip.style("display", "block")
                        .html(`Country: ${d.Country}<br>
                               Land Area: ${d["Land Area(Km2)"].toLocaleString()} sq km<br>
                               Forested Area: ${d["Forested Area (%)"].toFixed(2)}%<br>
                               CO2 Emissions: ${d["Co2-Emissions"].toLocaleString()} kt`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("display", "none");
                });
        }

        function animateAnnotation() {
            const annotationText = "Top CO2 Emmitors are under 50% Forested";
            const annotationDiv = d3.select("#animatedAnnotation");
            
            function animate() {
                annotationDiv.style("opacity", 0)
                    .text(annotationText)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1)
                    .transition()
                    .delay(3000)
                    .duration(1000)
                    .style("opacity", 0)
                    .on("end", animate);
            }
            
            animate();
        }
    </script>
</body>
</html>